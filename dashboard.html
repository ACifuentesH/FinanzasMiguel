<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Miguel</title>
  <!-- SDK stubs for standalone run -->
  <script>
  (function() {
    var store = JSON.parse(localStorage.getItem('miguelini_data') || '[]');
    window.dataSdk = {
      _store: store,
      _handler: null,
      init: function(handler) {
        this._handler = handler;
        this._store = JSON.parse(localStorage.getItem('miguelini_data') || '[]');
        if (handler && handler.onDataChanged) handler.onDataChanged(this._store);
        return Promise.resolve({ isOk: true });
      },
      create: function(item) {
        item.__backendId = 'id_' + Date.now() + '_' + Math.random().toString(36).slice(2);
        this._store.push(item);
        localStorage.setItem('miguelini_data', JSON.stringify(this._store));
        if (this._handler && this._handler.onDataChanged) this._handler.onDataChanged(this._store);
        if (window._persistToFile) window._persistToFile();
        if (window._persistToSheet) window._persistToSheet();
        return Promise.resolve({ isOk: true });
      },
      update: function(item) {
        var i = this._store.findIndex(function(x) { return x.__backendId === item.__backendId; });
        if (i >= 0) { this._store[i] = item; localStorage.setItem('miguelini_data', JSON.stringify(this._store)); }
        if (this._handler && this._handler.onDataChanged) this._handler.onDataChanged(this._store);
        if (window._persistToFile) window._persistToFile();
        if (window._persistToSheet) window._persistToSheet();
        return Promise.resolve({ isOk: true });
      },
      delete: function(item) {
        this._store = this._store.filter(function(x) { return x.__backendId !== item.__backendId; });
        localStorage.setItem('miguelini_data', JSON.stringify(this._store));
        if (this._handler && this._handler.onDataChanged) this._handler.onDataChanged(this._store);
        if (window._persistToFile) window._persistToFile();
        if (window._persistToSheet) window._persistToSheet();
        return Promise.resolve({ isOk: true });
      }
    };
    window.elementSdk = {
      config: {},
      init: function(opts) {
        if (opts && opts.defaultConfig) window.elementSdk.config = Object.assign({}, opts.defaultConfig);
        return Promise.resolve({ isOk: true });
      },
      setConfig: function(c) { Object.assign(window.elementSdk.config, c); }
    };
  })();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    
    .fade-in {
      animation: fadeIn 0.2s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .progress-bar {
      transition: width 0.4s ease;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app-container" class="h-full w-full overflow-auto" style="background: #f8f9fa;">
   <div class="min-h-full p-4 sm:p-6 md:p-8 max-w-7xl mx-auto"><!-- Header Personalizado -->
    <div class="mb-8 md:mb-12 fade-in">
     <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div>
       <h1 id="main-title" class="text-gray-900 font-semibold mb-1 text-2xl md:text-3xl lg:text-4xl">Hola, Miguel</h1>
       <p id="subtitle" class="text-gray-500 text-sm md:text-base">Panel de Control Financiero</p>
      </div>
      <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3"><!-- BCV Rate Display -->
       <div id="bcv-rate-display" class="bg-white border border-gray-200 px-4 py-2 rounded-lg">
        <p class="text-gray-500 text-xs mb-0.5">Dólar BCV</p>
        <p id="bcv-rate-value" class="text-gray-900 font-semibold text-sm">Cargando...</p>
       </div><button id="config-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium px-4 py-2 rounded-lg transition-colors text-sm whitespace-nowrap"> Configuración </button>
       <div class="flex items-center gap-2"><button id="prev-month-btn" class="bg-white border border-gray-200 hover:bg-gray-50 text-gray-700 p-3 rounded-lg transition-colors flex-shrink-0">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
         </svg></button>
        <div class="bg-white border border-gray-200 px-4 sm:px-6 py-3 rounded-lg flex-1 sm:flex-initial">
         <p id="current-month" class="text-gray-900 font-semibold text-sm text-center whitespace-nowrap">Enero 2024</p>
        </div><button id="next-month-btn" class="bg-white border border-gray-200 hover:bg-gray-50 text-gray-700 p-3 rounded-lg transition-colors flex-shrink-0">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
         </svg></button>
       </div>
      </div>
     </div>
    </div><!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-8 md:mb-10"><!-- Ingresos -->
     <div class="bg-white border border-gray-200 rounded-lg p-4 md:p-5">
      <p class="text-gray-500 text-xs font-medium mb-1 md:mb-2 uppercase tracking-wide">Ingresos</p>
      <p id="total-income" class="text-gray-900 font-semibold mb-1 text-xl md:text-2xl lg:text-3xl">$0</p>
      <p id="income-count" class="text-gray-400 text-xs">0 trans.</p>
     </div><!-- Gastos -->
     <div class="bg-white border border-gray-200 rounded-lg p-4 md:p-5">
      <p class="text-gray-500 text-xs font-medium mb-1 md:mb-2 uppercase tracking-wide">Gastos</p>
      <p id="total-expenses" class="text-gray-900 font-semibold mb-1 text-xl md:text-2xl lg:text-3xl">$0</p>
      <p id="expense-count" class="text-gray-400 text-xs">0 trans.</p>
     </div><!-- Balance -->
     <div class="bg-white border border-gray-200 rounded-lg p-4 md:p-5">
      <p class="text-gray-500 text-xs font-medium mb-1 md:mb-2 uppercase tracking-wide">Balance</p>
      <p id="balance" class="font-semibold mb-1 text-xl md:text-2xl lg:text-3xl">$0</p>
      <p id="balance-status" class="text-gray-400 text-xs">Histórico</p>
     </div><!-- Deudas -->
     <div class="bg-white border border-gray-200 rounded-lg p-4 md:p-5">
      <p class="text-gray-500 text-xs font-medium mb-1 md:mb-2 uppercase tracking-wide">Deudas</p>
      <p id="total-debts" class="text-gray-900 font-semibold mb-1 text-xl md:text-2xl lg:text-3xl">$0</p>
      <p id="monthly-debt-payment" class="text-gray-400 text-xs">Pago: $0</p>
     </div>
    </div><!-- Action Buttons -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-8 md:mb-10"><button id="add-income-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg transition-colors text-sm"> + Nuevo ingreso </button> <button id="add-expense-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg transition-colors text-sm"> + Nuevo gasto </button> <button id="add-debt-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg transition-colors text-sm"> + Nueva deuda </button>
    </div><!-- Charts Section -->
    <div id="charts-section" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 hidden"><!-- Balance by Payment Method Chart -->
     <div class="bg-white border border-gray-200 rounded-lg p-6">
      <h2 class="font-semibold text-gray-900 mb-4" style="font-size: 18px;">Balance por Método</h2>
      <div class="flex items-center justify-center mb-4">
       <div class="relative" style="width: 240px; height: 240px;">
        <svg id="balance-chart-svg" viewBox="0 0 200 200"><!-- SVG paths will be added here -->
        </svg>
        <div class="absolute inset-0 flex flex-col items-center justify-center">
         <p class="text-gray-500 text-xs">Disponible</p>
         <p id="balance-chart-total" class="text-gray-900 font-semibold" style="font-size: 24px;">$0</p>
        </div>
       </div>
      </div>
      <div id="balance-legend" class="space-y-2"><!-- Legend items will be added here -->
      </div>
     </div><!-- Expense Distribution Chart -->
     <div class="bg-white border border-gray-200 rounded-lg p-6">
      <h2 class="font-semibold text-gray-900 mb-4" style="font-size: 18px;">Distribución de Gastos</h2>
      <div class="flex items-center justify-center mb-4">
       <div class="relative" style="width: 240px; height: 240px;">
        <svg id="expense-chart-svg" viewBox="0 0 200 200"><!-- SVG paths will be added here -->
        </svg>
        <div class="absolute inset-0 flex flex-col items-center justify-center">
         <p class="text-gray-500 text-xs">Total</p>
         <p id="chart-total" class="text-gray-900 font-semibold" style="font-size: 24px;">$0</p>
        </div>
       </div>
      </div>
      <div id="expense-legend" class="space-y-2"><!-- Legend items will be added here -->
      </div>
     </div>
    </div><!-- Deudas Pendientes Section -->
    <div id="debts-section" class="bg-white border border-gray-200 rounded-lg p-6 mb-8 hidden">
     <h2 class="font-semibold text-gray-900 mb-6" style="font-size: 18px;">Plan de Pagos</h2>
     <div id="debts-list" class="space-y-4"><!-- Deudas aparecerán aquí -->
     </div>
     <div id="debt-warning" class="hidden mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
      <p class="text-gray-700 text-sm">⚠ ️Los pagos mensuales de deudas superan tu balance disponible.</p>
     </div>
    </div><!-- Transactions List -->
    <div class="bg-white border border-gray-200 rounded-lg p-6">
     <h2 class="font-semibold text-gray-900 mb-6" style="font-size: 18px;">Transacciones</h2>
     <div id="transactions-list" class="space-y-2"><!-- Transactions will be added here -->
     </div>
     <div id="empty-state" class="text-center py-12">
      <p class="text-gray-400" style="font-size: 15px;">No hay transacciones</p>
      <p class="text-gray-400 mt-1 text-sm">Agrega ingresos, gastos o deudas</p>
     </div>
    </div><!-- Configuración (métodos de pago, datos, programadas) -->
    <div id="config-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4" style="z-index: 1002;">
     <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl fade-in max-h-[90vh] overflow-hidden flex flex-col">
      <div class="p-4 border-b border-gray-200 flex justify-between items-center flex-shrink-0">
       <h2 class="font-semibold text-gray-900" style="font-size: 20px;">Configuración</h2>
       <button type="button" id="close-config-btn" class="text-gray-400 hover:text-gray-900 transition-colors p-1">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
       </button>
      </div>
      <div class="p-4 overflow-y-auto flex-1 space-y-6">
       <!-- 1. Métodos de pago -->
       <div>
        <h3 class="font-medium text-gray-900 mb-2" style="font-size: 16px;">Métodos de pago</h3>
        <p class="text-gray-500 text-xs mb-2">Agrega métodos para usarlos al registrar ingresos o gastos.</p>
        <div class="flex gap-2">
         <input type="text" id="new-payment-method-input" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Ej: PayPal, Pago móvil">
         <button type="button" id="add-payment-method-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg text-sm whitespace-nowrap">Agregar</button>
        </div>
       </div>
       <!-- 2. Datos -->
       <div class="border-t border-gray-200 pt-4">
        <h3 class="font-medium text-gray-900 mb-2" style="font-size: 16px;">Datos</h3>
        <p class="text-gray-500 text-xs mb-3">Exportar, importar o guardar en archivo / Google Sheet.</p>
        <div class="space-y-3">
         <div class="flex flex-wrap gap-2">
          <button type="button" id="open-file-btn" class="bg-emerald-700 hover:bg-emerald-600 text-white font-medium py-2 px-3 rounded-lg text-sm">Abrir archivo</button>
          <button type="button" id="save-file-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-medium py-2 px-3 rounded-lg text-sm">Guardar como archivo</button>
          <button type="button" id="export-data-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-3 rounded-lg text-sm">Descargar JSON</button>
          <button type="button" id="copy-data-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-3 rounded-lg text-sm">Copiar</button>
          <button type="button" id="export-csv-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-3 rounded-lg text-sm">Descargar CSV</button>
          <button type="button" id="save-csv-file-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-3 rounded-lg text-sm">Guardar CSV en archivo</button>
         </div>
         <textarea id="import-json-input" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono" placeholder='Pega JSON para importar'></textarea>
         <button type="button" id="import-data-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg text-sm">Importar y recargar</button>
         <p id="file-status" class="text-sm text-gray-600"></p>
         <div class="pt-2 border-t border-gray-100">
          <p class="text-gray-600 text-xs font-medium mb-1">Google Sheet</p>
          <input type="url" id="google-sheet-url" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-1" placeholder="https://script.google.com/macros/s/.../exec">
          <p id="sync-active-msg" class="text-xs text-green-600 mb-1 hidden">✓ Sincronización activa.</p>
          <div class="flex flex-wrap gap-2">
           <button type="button" id="send-to-sheet-btn" class="bg-green-700 hover:bg-green-600 text-white font-medium py-2 px-3 rounded-lg text-sm">Enviar al Sheet</button>
           <button type="button" id="fetch-from-sheet-btn" class="bg-green-600 hover:bg-green-500 text-white font-medium py-2 px-3 rounded-lg text-sm">Traer del Sheet</button>
           <button type="button" id="copy-mobile-link-btn" class="text-sm text-gray-600 hover:text-gray-900 underline">Enlace para móvil</button>
          </div>
          <p id="sheet-status" class="text-sm mt-1 hidden"></p>
         </div>
        </div>
       </div>
       <!-- 3. Transacciones programadas -->
       <div class="border-t border-gray-200 pt-4">
        <h3 class="font-medium text-gray-900 mb-2" style="font-size: 16px;">Transacciones programadas</h3>
        <p class="text-gray-500 text-xs mb-3">Ingresos y gastos recurrentes que se generan automáticamente.</p>
        <button type="button" id="add-template-btn" class="bg-gray-800 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg text-sm mb-3">+ Nueva transacción programada</button>
        <div id="templates-list" class="space-y-2"></div>
        <div id="templates-empty" class="text-center py-6">
         <p class="text-gray-400 text-sm">No hay transacciones programadas</p>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Transaction Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4" style="z-index: 1001;">
     <div class="bg-white rounded-lg shadow-xl w-full max-w-md fade-in overflow-y-auto" style="max-height: 90vh;">
      <div id="modal-header" class="p-6 border-b border-gray-200">
       <h3 id="modal-title" class="font-semibold text-gray-900" style="font-size: 18px;">Agregar Ingreso</h3>
      </div>
      <form id="transaction-form" class="p-6 space-y-4">
       <div id="creditor-field" class="hidden"><label for="creditor" class="block text-gray-700 text-sm font-medium mb-2">Acreedor</label> <input type="text" id="creditor" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm" placeholder="Banco, Tarjeta...">
       </div>
       <div><label for="description" class="block text-gray-700 text-sm font-medium mb-2">Descripción</label> <input type="text" id="description" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm" placeholder="Salario, Comida, etc.">
       </div>
       <div id="date-field"><label for="transaction-date" class="block text-gray-700 text-sm font-medium mb-2">Fecha de la transacción</label> <input type="date" id="transaction-date" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm">
        <p class="text-gray-500 text-xs mt-1"> Puedes seleccionar fechas pasadas para tu historial</p>
       </div>
       <div id="total-debt-field" class="hidden"><label for="total-debt" class="block text-gray-700 text-sm font-medium mb-2">Deuda Total ($)</label> <input type="number" id="total-debt" step="0.01" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm" placeholder="0.00">
       </div>
       <div id="currency-field" class="hidden"><label for="currency" id="currency-label" class="block text-gray-700 text-sm font-medium mb-2">¿En qué moneda lo recibiste?</label> <select id="currency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm"> <option value="$">Dólares ($)</option> <option value="Bs">Bolívares (Bs)</option> </select>
       </div>
       <div><label for="amount" class="block text-gray-700 text-sm font-medium mb-2"> <span id="amount-label">Monto</span> <span id="currency-symbol-display" class="text-gray-500">($)</span> </label> <input type="number" id="amount" required step="0.01" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm" placeholder="0.00">
        <p id="conversion-preview" class="text-gray-500 text-xs mt-1 hidden"></p>
       </div>
       <div id="historical-rate-field" class="hidden"><label for="historical-rate-input" class="block text-gray-700 text-sm font-medium mb-2">Tasa BCV de esa fecha (Bs por $1)</label> <input type="number" id="historical-rate-input" step="0.01" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm" placeholder="Ej: 36.50">
        <p class="text-gray-500 text-xs mt-1"> Ingresa la tasa BCV que estaba vigente ese día (Tasa actual: Bs <span id="current-rate-hint">--</span>)</p>
       </div>
       <div id="category-field"><label for="category" class="block text-gray-700 text-sm font-medium mb-2">Categoría</label> <select id="category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm"> <option value="">Seleccionar...</option> </select>
       </div>
       <div id="payment-frequency-field" class="hidden"><label for="payment-frequency" class="block text-gray-700 text-sm font-medium mb-2">Frecuencia de pago</label> <select id="payment-frequency" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm"> <option value="single">Pago único (un solo día)</option> <option value="biweekly">Quincenal (día 15 y 30)</option> </select>
       </div>
       <div id="scheduled-day-field-main" class="hidden"><label for="scheduled-day-main" class="block text-gray-700 text-sm font-medium mb-2">Día del mes (1-31)</label> <input type="number" id="scheduled-day-main" min="1" max="31" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm" placeholder="Ej: 1 para el primer día del mes">
        <p class="text-gray-500 text-xs mt-1">Se generará automáticamente si hoy es igual o posterior a este día</p>
       </div>
       <div id="payment-method-field" class="hidden">
        <label class="block text-gray-700 text-sm font-medium mb-2">Método de pago</label>
        <select id="payment-method" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm"></select>
        <div id="split-payment-toggle" class="mb-2 mt-2 hidden">
         <label class="inline-flex items-center gap-2 cursor-pointer">
          <input type="checkbox" id="split-payment-checkbox" class="rounded border-gray-300">
          <span class="text-sm text-gray-700">Dividir pago entre varios métodos</span>
         </label>
        </div>
        <div id="payment-splits-container" class="hidden mt-2 space-y-2 p-3 bg-gray-50 rounded-lg">
         <p class="text-xs text-gray-600 mb-2">Indica cuánto pagaste con cada método. El total debe coincidir con el monto.</p>
         <div id="payment-splits-list"></div>
         <p id="payment-splits-total" class="text-sm font-medium text-gray-700">Total: $0.00</p>
         <button type="button" id="add-split-row-btn" class="text-sm text-gray-600 hover:text-gray-900">+ Añadir otro método</button>
        </div>
       </div>
       <div id="notes-field" class="hidden"><label for="notes" class="block text-gray-700 text-sm font-medium mb-2">Notas adicionales (opcional)</label> <textarea id="notes" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm resize-none" placeholder="Ej: Este dinero está en Zelle de Camila..."></textarea>
        <p class="text-gray-500 text-xs mt-1"> Agrega información extra para recordar detalles importantes</p>
       </div>
       <div class="flex gap-3 pt-2"><button type="submit" id="submit-btn" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white font-medium py-2 rounded-lg transition-colors text-sm"> <span id="submit-btn-text">Guardar</span> </button> <button type="button" id="cancel-btn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 rounded-lg transition-colors text-sm"> Cancelar </button>
       </div>
      </form>
     </div>
    </div><!-- Loading Indicator -->
    <div id="loading" class="fixed top-6 right-6 bg-white border border-gray-200 px-4 py-3 rounded-lg shadow-lg hidden">
     <div class="flex items-center gap-2">
      <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-800"></div><span class="text-gray-700 text-sm font-medium">Guardando...</span>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      background_color: '#f8f9fa',
      card_background: '#ffffff',
      text_color: '#111827',
      accent_color: '#6b7280',
      button_color: '#374151',
      font_family: 'Inter',
      font_size: 14,
      user_name: 'Miguel',
      dashboard_subtitle: 'Panel de Control Financiero',
      income_button_label: 'Nuevo ingreso',
      expense_button_label: 'Nuevo gasto',
      debt_button_label: 'Nueva deuda'
    };

    let currentData = [];
    let currentTransactionType = 'income';
    let isTemplateMode = false;
    let editingTransaction = null;
    let currentBcvRate = null;

    const incomeCategories = ['Salario', 'Freelance', 'Inversiones', 'Ventas', 'Regalo', 'Otros ingresos'];
    const expenseCategories = ['Vivienda', 'Alimentación', 'Transporte', 'Entretenimiento', 'Salud', 'Educación', 'Herramientas', 'Deudas', 'Otros gastos'];
    const DEFAULT_PAYMENT_METHODS = ['Mercantil', 'BNC', 'Provincial', 'Efectivo', 'Zelle', 'Kontigo', 'Zinli', 'Tarjeta Kontigo'];
    function getPaymentMethods() {
      try {
        const saved = localStorage.getItem('miguelini_payment_methods');
        return saved ? JSON.parse(saved) : DEFAULT_PAYMENT_METHODS.slice();
      } catch (e) { return DEFAULT_PAYMENT_METHODS.slice(); }
    }
    function addPaymentMethod(name) {
      const n = (name || '').trim();
      if (!n) return getPaymentMethods();
      const methods = getPaymentMethods();
      if (methods.indexOf(n) === -1) {
        methods.push(n);
        localStorage.setItem('miguelini_payment_methods', JSON.stringify(methods));
      }
      return methods;
    }
    function refreshPaymentMethodSelect(selectId) {
      const sel = document.getElementById(selectId || 'payment-method');
      if (!sel) return;
      const methods = getPaymentMethods();
      const current = sel.value;
      sel.innerHTML = '<option value="">Seleccionar...</option>' + methods.map(m => `<option value="${m}">${m}</option>`).join('');
      if (current && methods.indexOf(current) !== -1) sel.value = current;
    }
    function refreshAllPaymentMethodSelects() {
      refreshPaymentMethodSelect('payment-method');
      document.querySelectorAll('.split-method-select').forEach(s => {
        const id = s.id;
        if (id) refreshPaymentMethodSelect(id);
      });
    }
    
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    // Fetch BCV Rate (current)
    async function fetchBcvRate() {
      try {
        const response = await fetch('https://ve.dolarapi.com/v1/dolares/oficial');
        const data = await response.json();
        currentBcvRate = data.promedio;
        
        const bcvDisplay = document.getElementById('bcv-rate-value');
        bcvDisplay.textContent = `Bs ${currentBcvRate.toFixed(2)}`;
        
        return currentBcvRate;
      } catch (error) {
        console.error('Error fetching BCV rate:', error);
        const bcvDisplay = document.getElementById('bcv-rate-value');
        bcvDisplay.textContent = 'No disponible';
        return null;
      }
    }

    // Update conversion preview and historical rate field
    async function updateConversionPreview() {
      const amountInput = document.getElementById('amount');
      const currencySelect = document.getElementById('currency');
      const conversionPreview = document.getElementById('conversion-preview');
      const currencySymbolDisplay = document.getElementById('currency-symbol-display');
      const dateInput = document.getElementById('transaction-date');
      const historicalRateField = document.getElementById('historical-rate-field');
      const historicalRateInput = document.getElementById('historical-rate-input');
      const currentRateHint = document.getElementById('current-rate-hint');
      
      const amount = parseFloat(amountInput.value);
      const currency = currencySelect.value;
      
      if (currency === '$') {
        currencySymbolDisplay.textContent = '($)';
      } else {
        currencySymbolDisplay.textContent = '(Bs)';
      }
      
      // Update current rate hint
      if (currentBcvRate) {
        currentRateHint.textContent = currentBcvRate.toFixed(2);
      }
      
      // Check if date is in the past
      const selectedDate = dateInput.value ? new Date(dateInput.value + 'T12:00:00') : new Date();
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      selectedDate.setHours(0, 0, 0, 0);
      
      const isPastDate = selectedDate < today;
      const needsHistoricalRate = currency === 'Bs' && isPastDate && !isTemplateMode;
      
      // Show/hide historical rate field
      if (needsHistoricalRate) {
        historicalRateField.classList.remove('hidden');
        historicalRateInput.required = true;
      } else {
        historicalRateField.classList.add('hidden');
        historicalRateInput.required = false;
      }
      
      if (!amount || !currentBcvRate) {
        conversionPreview.classList.add('hidden');
        return;
      }
      
      // Use historical rate if provided, otherwise current rate
      let rateToUse = currentBcvRate;
      if (needsHistoricalRate && historicalRateInput.value) {
        rateToUse = parseFloat(historicalRateInput.value) || currentBcvRate;
      }
      
      if (currency === 'Bs') {
        const dollarsEquivalent = amount / rateToUse;
        if (needsHistoricalRate) {
          conversionPreview.textContent = `≈  $${dollarsEquivalent.toFixed(2)} USD (Usando tasa: Bs ${rateToUse.toFixed(2)})`;
        } else {
          conversionPreview.textContent = `≈  $${dollarsEquivalent.toFixed(2)} USD (Tasa BCV actual: Bs ${rateToUse.toFixed(2)})`;
        }
        conversionPreview.classList.remove('hidden');
      } else {
        const bolivaresEquivalent = amount * rateToUse;
        conversionPreview.textContent = `≈  Bs ${bolivaresEquivalent.toFixed(2)} (Tasa BCV actual: Bs ${rateToUse.toFixed(2)})`;
        conversionPreview.classList.remove('hidden');
      }
    }

    const dataHandler = {
      onDataChanged(data) {
        currentData = data;
        updateUI();
      }
    };

    function onConfigChange(config) {
      const container = document.getElementById('app-container');
      const title = document.getElementById('main-title');
      const subtitle = document.getElementById('subtitle');
      const incomeBtn = document.getElementById('add-income-btn');
      const expenseBtn = document.getElementById('add-expense-btn');
      const debtBtn = document.getElementById('add-debt-btn');
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const baseFontStack = 'system-ui, -apple-system, sans-serif';

      container.style.background = config.background_color || defaultConfig.background_color;
      
      title.textContent = `Hola, ${config.user_name || defaultConfig.user_name}`;
      title.style.fontFamily = `${customFont}, ${baseFontStack}`;
      title.style.fontSize = `${baseSize * 2.3}px`;
      title.style.color = config.text_color || defaultConfig.text_color;
      
      subtitle.textContent = config.dashboard_subtitle || defaultConfig.dashboard_subtitle;
      subtitle.style.fontFamily = `${customFont}, ${baseFontStack}`;
      subtitle.style.fontSize = `${baseSize * 1.07}px`;
      
      const buttonColor = config.button_color || defaultConfig.button_color;
      
      incomeBtn.textContent = `+ ${config.income_button_label || defaultConfig.income_button_label}`;
      incomeBtn.style.fontFamily = `${customFont}, ${baseFontStack}`;
      incomeBtn.style.fontSize = `${baseSize}px`;
      incomeBtn.style.backgroundColor = buttonColor;
      
      expenseBtn.textContent = `+ ${config.expense_button_label || defaultConfig.expense_button_label}`;
      expenseBtn.style.fontFamily = `${customFont}, ${baseFontStack}`;
      expenseBtn.style.fontSize = `${baseSize}px`;
      expenseBtn.style.backgroundColor = buttonColor;
      
      debtBtn.textContent = `+ ${config.debt_button_label || defaultConfig.debt_button_label}`;
      debtBtn.style.fontFamily = `${customFont}, ${baseFontStack}`;
      debtBtn.style.fontSize = `${baseSize}px`;
      debtBtn.style.backgroundColor = buttonColor;
      
      document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, button, input, select, label').forEach(el => {
        el.style.fontFamily = `${customFont}, ${baseFontStack}`;
      });
      
      updateUI();
    }

    function getMonthName(month) {
      const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      return months[month];
    }
    
    function filterByMonth(transactions) {
      return transactions.filter(t => {
        if (t.isTemplate) return false;
        const transactionDate = new Date(t.createdAt);
        return transactionDate.getMonth() === currentMonth && 
               transactionDate.getFullYear() === currentYear;
      });
    }
    
    function updateMonthDisplay() {
      const monthDisplay = document.getElementById('current-month');
      monthDisplay.textContent = `${getMonthName(currentMonth)} ${currentYear}`;
    }
    
    async function checkAndProcessScheduledTransactions() {
      const today = new Date();
      const todayDay = today.getDate();
      
      const templates = currentData.filter(t => t.isTemplate === true);
      
      if (templates.length === 0) return;
      
      let created = 0;
      
      for (const template of templates) {
        const shouldProcess = await processTemplateForMonth(template, currentYear, currentMonth, todayDay);
        if (shouldProcess) created++;
      }
      
      if (created > 0) {
        showToast(`✅  ${created} transacción(es) generadas automáticamente`, 'success');
      }
    }

    async function processTemplateForMonth(template, year, month, currentDayOfMonth) {
      let created = false;
      
      if (template.isBiweekly) {
        if (currentDayOfMonth >= 15) {
          const day15Exists = currentData.some(t => {
            if (t.isTemplate) return false;
            const tDate = new Date(t.createdAt);
            return t.description === (template.description + ' (Quincena 1)') &&
                   Math.abs(t.amount - template.amount / 2) < 0.01 &&
                   t.type === template.type &&
                   tDate.getMonth() === month &&
                   tDate.getFullYear() === year &&
                   tDate.getDate() === 15;
          });
          
          if (!day15Exists) {
            if (currentData.length >= 999) return false;
            
            const dateDay15 = new Date(year, month, 15, 12, 0, 0);
            const newTransaction15 = {
              id: Date.now().toString() + '_15_' + Math.random().toString(36).substr(2, 9),
              type: template.type,
              description: template.description + ' (Quincena 1)',
              amount: template.amount / 2,
              category: template.category,
              isRecurring: false,
              isTemplate: false,
              scheduledDay: 15,
              date: dateDay15.toISOString().split('T')[0],
              createdAt: dateDay15.toISOString(),
              currency: template.currency || '$',
              paymentMethod: template.paymentMethod || '',
              notes: template.notes || '',
              originalAmount: template.originalAmount || (template.amount / 2),
              originalCurrency: template.originalCurrency || template.currency || '$',
              bcvRate: template.bcvRate || currentBcvRate
            };
            
            const result = await window.dataSdk.create(newTransaction15);
            if (result.isOk) created = true;
          }
        }
        
        const lastDay = new Date(year, month + 1, 0).getDate();
        const actualDay = Math.min(30, lastDay);
        
        if (currentDayOfMonth >= actualDay) {
          const day30Exists = currentData.some(t => {
            if (t.isTemplate) return false;
            const tDate = new Date(t.createdAt);
            return t.description === (template.description + ' (Quincena 2)') &&
                   Math.abs(t.amount - template.amount / 2) < 0.01 &&
                   t.type === template.type &&
                   tDate.getMonth() === month &&
                   tDate.getFullYear() === year &&
                   tDate.getDate() === actualDay;
          });
          
          if (!day30Exists) {
            if (currentData.length >= 999) return created;
            
            const dateDay30 = new Date(year, month, actualDay, 12, 0, 0);
            
            const newTransaction30 = {
              id: Date.now().toString() + '_30_' + Math.random().toString(36).substr(2, 9),
              type: template.type,
              description: template.description + ' (Quincena 2)',
              amount: template.amount / 2,
              category: template.category,
              isRecurring: false,
              isTemplate: false,
              scheduledDay: 30,
              date: dateDay30.toISOString().split('T')[0],
              createdAt: dateDay30.toISOString(),
              currency: template.currency || '$',
              paymentMethod: template.paymentMethod || '',
              notes: template.notes || '',
              originalAmount: template.originalAmount || (template.amount / 2),
              originalCurrency: template.originalCurrency || template.currency || '$',
              bcvRate: template.bcvRate || currentBcvRate
            };
            
            const result = await window.dataSdk.create(newTransaction30);
            if (result.isOk) created = true;
          }
        }
      } else {
        if (currentDayOfMonth >= template.scheduledDay) {
          const alreadyExists = currentData.some(t => {
            if (t.isTemplate) return false;
            const tDate = new Date(t.createdAt);
            
            return t.description === template.description &&
                   Math.abs(t.amount - template.amount) < 0.01 &&
                   t.type === template.type &&
                   tDate.getMonth() === month &&
                   tDate.getFullYear() === year &&
                   tDate.getDate() === template.scheduledDay;
          });
          
          if (!alreadyExists) {
            if (currentData.length >= 999) return false;
            
            const scheduledDate = new Date(year, month, template.scheduledDay, 12, 0, 0);
            
            const newTransaction = {
              id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
              type: template.type,
              description: template.description,
              amount: template.amount,
              category: template.category,
              isRecurring: false,
              isTemplate: false,
              scheduledDay: template.scheduledDay,
              date: scheduledDate.toISOString().split('T')[0],
              createdAt: scheduledDate.toISOString(),
              currency: template.currency || '$',
              paymentMethod: template.paymentMethod || '',
              notes: template.notes || '',
              originalAmount: template.originalAmount || template.amount,
              originalCurrency: template.originalCurrency || template.currency || '$',
              bcvRate: template.bcvRate || currentBcvRate
            };
            
            const result = await window.dataSdk.create(newTransaction);
            if (result.isOk) created = true;
          }
        }
      }
      
      return created;
    }
    
    function updateUI() {
      updateMonthDisplay();
      renderTemplates();
      
      const monthlyData = filterByMonth(currentData);
      
      const incomes = monthlyData.filter(t => t.type === 'income');
      const expenses = monthlyData.filter(t => t.type === 'expense');
      const debts = currentData.filter(t => t.type === 'debt' && !t.isTemplate);
      
      const totalIncome = incomes.reduce((sum, t) => sum + t.amount, 0);
      const totalExpenses = expenses.reduce((sum, t) => sum + t.amount, 0);
      const totalDebtAmount = debts.reduce((sum, t) => {
        const paidAmount = t.paidAmount || 0;
        const remaining = t.totalDebt - paidAmount;
        return sum + (remaining > 0 ? remaining : 0);
      }, 0);
      const monthlyDebtPayment = debts.reduce((sum, t) => {
        const paidAmount = t.paidAmount || 0;
        const remaining = t.totalDebt - paidAmount;
        return sum + (remaining > 0 ? t.monthlyPayment : 0);
      }, 0);
      
      const currentMonthEnd = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59);
      const allHistoricalData = currentData.filter(t => {
        if (t.isTemplate) return false;
        const tDate = new Date(t.createdAt);
        return tDate <= currentMonthEnd;
      });
      
      const allHistoricalIncomes = allHistoricalData.filter(t => t.type === 'income');
      const allHistoricalExpenses = allHistoricalData.filter(t => t.type === 'expense');
      
      const totalHistoricalIncome = allHistoricalIncomes.reduce((sum, t) => sum + t.amount, 0);
      const totalHistoricalExpenses = allHistoricalExpenses.reduce((sum, t) => sum + t.amount, 0);
      
      const balance = totalHistoricalIncome - totalHistoricalExpenses;
      
      const config = window.elementSdk?.config || defaultConfig;
      
      document.getElementById('total-income').textContent = `$${totalIncome.toFixed(2)}`;
      document.getElementById('income-count').textContent = `${incomes.length} trans.`;
      
      document.getElementById('total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
      document.getElementById('expense-count').textContent = `${expenses.length} trans.`;
      
      const balanceEl = document.getElementById('balance');
      balanceEl.textContent = `$${balance.toFixed(2)}`;
      balanceEl.style.color = balance >= 0 ? (config.text_color || defaultConfig.text_color) : '#9ca3af';
      
      const balanceStatus = document.getElementById('balance-status');
      balanceStatus.textContent = 'Histórico';
      
      document.getElementById('total-debts').textContent = `$${totalDebtAmount.toFixed(2)}`;
      document.getElementById('monthly-debt-payment').textContent = `Pago: $${monthlyDebtPayment.toFixed(2)}`;
      
      const debtWarning = document.getElementById('debt-warning');
      if (monthlyDebtPayment > balance && balance > 0 && debts.length > 0) {
        debtWarning.classList.remove('hidden');
      } else {
        debtWarning.classList.add('hidden');
      }
      
      renderBalanceChart();
      renderExpenseChart();
      renderDebts();
      renderTransactions();
    }

    function renderTemplates() {
      const templates = currentData.filter(t => t.isTemplate === true);
      const templatesList = document.getElementById('templates-list');
      const templatesEmpty = document.getElementById('templates-empty');
      
      if (templates.length === 0) {
        templatesList.innerHTML = '';
        templatesEmpty.classList.remove('hidden');
        return;
      }
      
      templatesEmpty.classList.add('hidden');
      
      templatesList.innerHTML = templates.map(template => {
        const typeLabel = template.type === 'income' ? 'Ingreso' : 'Gasto';
        const typeColor = template.type === 'income' ? 'bg-gray-100 text-gray-700' : 'bg-gray-200 text-gray-800';
        
        let scheduleText = '';
        if (template.isBiweekly) {
          scheduleText = '<span class="bg-gray-300 text-gray-800 text-xs font-medium px-2 py-1 rounded">Quincenal (15 y 30)</span>';
        } else {
          scheduleText = `<span class="bg-gray-100 text-gray-700 text-xs font-medium px-2 py-1 rounded">Día ${template.scheduledDay}</span>`;
        }
        
        const notesDisplay = template.notes ? `<p class="text-gray-500 text-xs mt-1"> ${template.notes}</p>` : '';
        
        const originalCurrency = template.originalCurrency || template.currency || '$';
        const originalAmount = template.originalAmount || template.amount;
        const currencyBadge = `<span class="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded font-medium">${originalCurrency}</span>`;
        
        let amountDisplay = `$${template.amount.toFixed(2)}`;
        if (originalCurrency === 'Bs' && template.bcvRate) {
          amountDisplay += ` <span class="text-gray-500 text-xs">(Bs ${originalAmount.toFixed(2)} @ Bs ${template.bcvRate.toFixed(2)})</span>`;
        }
        
        return `
          <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="${typeColor} text-xs font-medium px-2 py-1 rounded">${typeLabel}</span>
                  ${scheduleText}
                  ${currencyBadge}
                </div>
                <h4 class="font-semibold text-gray-900 mb-1">${template.description}</h4>
                <div class="flex items-center gap-4 text-sm">
                  <p class="text-gray-600">${template.category}</p>
                  <span class="text-gray-900 font-semibold">${amountDisplay}</span>
                  ${template.isBiweekly ? '<span class="text-gray-500 text-xs">($' + (template.amount / 2).toFixed(2) + ' cada quincena)</span>' : ''}
                </div>
                ${notesDisplay}
              </div>
              <div class="flex items-center gap-2 ml-4">
                <button onclick="editTransaction('${template.__backendId}')" class="text-gray-400 hover:text-gray-600 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                </button>
                <button onclick="deleteTransaction('${template.__backendId}')" class="text-gray-400 hover:text-gray-700 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function createDonutChart(data, colors, svgId) {
      const svg = document.getElementById(svgId);
      svg.innerHTML = '';
      
      const total = data.reduce((sum, [_, amount]) => sum + amount, 0);
      const radius = 70;
      const strokeWidth = 25;
      const centerX = 100;
      const centerY = 100;
      const circumference = 2 * Math.PI * radius;
      
      let currentOffset = 0;
      
      data.forEach(([label, amount], index) => {
        const percentage = amount / total;
        const strokeDasharray = circumference * percentage;
        const strokeDashoffset = -currentOffset;
        
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', centerX);
        circle.setAttribute('cy', centerY);
        circle.setAttribute('r', radius);
        circle.setAttribute('fill', 'transparent');
        circle.setAttribute('stroke', colors[index % colors.length]);
        circle.setAttribute('stroke-width', strokeWidth);
        circle.setAttribute('stroke-dasharray', `${strokeDasharray} ${circumference}`);
        circle.setAttribute('stroke-dashoffset', strokeDashoffset);
        circle.setAttribute('transform', `rotate(-90 ${centerX} ${centerY})`);
        
        svg.appendChild(circle);
        
        currentOffset += strokeDasharray;
      });
    }

    function renderBalanceChart() {
      const currentMonthEnd = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59);
      const allDataUpToNow = currentData.filter(t => {
        if (t.isTemplate) return false;
        const tDate = new Date(t.createdAt);
        return tDate <= currentMonthEnd;
      });
      
      const incomes = allDataUpToNow.filter(t => t.type === 'income');
      const expenses = allDataUpToNow.filter(t => t.type === 'expense');
      const debts = allDataUpToNow.filter(t => t.type === 'debt');
      const chartsSection = document.getElementById('charts-section');
      
      if (incomes.length === 0 && expenses.length === 0) {
        chartsSection.classList.add('hidden');
        return;
      }
      
      const balanceByMethod = {};
      
      incomes.forEach(income => {
        const method = income.paymentMethod || 'Sin especificar';
        balanceByMethod[method] = (balanceByMethod[method] || 0) + income.amount;
      });
      
      expenses.forEach(expense => {
        const method = expense.paymentMethod || 'Sin especificar';
        balanceByMethod[method] = (balanceByMethod[method] || 0) - expense.amount;
      });
      
      const allBalances = Object.entries(balanceByMethod)
        .sort((a, b) => b[1] - a[1]);
      
      if (allBalances.length === 0) {
        chartsSection.classList.add('hidden');
        return;
      }
      
      chartsSection.classList.remove('hidden');
      
      const totalBalance = allBalances.reduce((sum, [_, amount]) => sum + amount, 0);
      document.getElementById('balance-chart-total').textContent = `$${totalBalance.toFixed(2)}`;
      
      const positiveBalances = allBalances.filter(([_, amount]) => amount > 0);
      
      if (positiveBalances.length > 0) {
        const colors = ['#1f2937', '#374151', '#4b5563', '#6b7280', '#9ca3af', '#d1d5db'];
        const totalPositive = positiveBalances.reduce((sum, [_, amount]) => sum + amount, 0);
        
        createDonutChart(positiveBalances, colors, 'balance-chart-svg');
        
        const legend = document.getElementById('balance-legend');
        legend.innerHTML = allBalances.map(([method, amount], index) => {
          const isPositive = amount > 0;
          const percentage = isPositive ? ((amount / totalPositive) * 100).toFixed(1) : '0.0';
          const textColor = isPositive ? 'text-gray-900' : 'text-gray-400';
          
          return `
            <div class="flex items-center justify-between py-2 border-b border-gray-100">
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${isPositive ? colors[positiveBalances.findIndex(([m]) => m === method) % colors.length] : '#e5e7eb'};"></div>
                <p class="text-gray-700 text-sm font-medium">${method}</p>
              </div>
              <div class="flex items-center gap-3">
                <p class="text-gray-500 text-xs">${percentage}%</p>
                <p class="${textColor} font-semibold text-sm min-w-[70px] text-right">${amount >= 0 ? '+' : ''}$${amount.toFixed(2)}</p>
              </div>
            </div>
          `;
        }).join('');
      } else {
        document.getElementById('balance-chart-svg').innerHTML = '';
        document.getElementById('balance-chart-total').textContent = `$${totalBalance.toFixed(2)}`;
        
        const legend = document.getElementById('balance-legend');
        legend.innerHTML = allBalances.map(([method, amount]) => {
          return `
            <div class="flex items-center justify-between py-2 border-b border-gray-100">
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full flex-shrink-0 bg-gray-300"></div>
                <p class="text-gray-700 text-sm font-medium">${method}</p>
              </div>
              <div class="flex items-center gap-3">
                <p class="text-gray-500 text-xs">0.0%</p>
                <p class="text-gray-400 font-semibold text-sm min-w-[70px] text-right">$${amount.toFixed(2)}</p>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function renderExpenseChart() {
      const monthlyData = filterByMonth(currentData);
      const expenses = monthlyData.filter(t => t.type === 'expense');
      const chartsSection = document.getElementById('charts-section');
      
      if (expenses.length === 0) {
        chartsSection.classList.add('hidden');
        return;
      }
      
      chartsSection.classList.remove('hidden');
      
      const categoryTotals = {};
      expenses.forEach(expense => {
        const category = expense.category || 'Otros gastos';
        categoryTotals[category] = (categoryTotals[category] || 0) + expense.amount;
      });
      
      const totalExpenses = Object.values(categoryTotals).reduce((sum, val) => sum + val, 0);
      document.getElementById('chart-total').textContent = `$${totalExpenses.toFixed(2)}`;
      
      if (totalExpenses === 0) {
        chartsSection.classList.add('hidden');
        return;
      }
      
      const colors = ['#111827', '#1f2937', '#374151', '#4b5563', '#6b7280', '#9ca3af'];
      const categories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
      
      createDonutChart(categories, colors, 'expense-chart-svg');
      
      const legend = document.getElementById('expense-legend');
      legend.innerHTML = categories.map(([category, amount], index) => {
        const percentage = ((amount / totalExpenses) * 100).toFixed(1);
        
        return `
          <div class="flex items-center justify-between py-2 border-b border-gray-100">
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${colors[index % colors.length]};"></div>
              <p class="text-gray-700 text-sm font-medium">${category}</p>
            </div>
            <div class="flex items-center gap-3">
              <p class="text-gray-500 text-xs">${percentage}%</p>
              <p class="text-gray-900 font-semibold text-sm min-w-[70px] text-right">$${amount.toFixed(2)}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderDebts() {
      const debts = currentData.filter(t => t.type === 'debt' && !t.isTemplate);
      const debtsSection = document.getElementById('debts-section');
      const debtsList = document.getElementById('debts-list');
      const config = window.elementSdk?.config || defaultConfig;
      
      if (debts.length === 0) {
        debtsSection.classList.add('hidden');
        return;
      }
      
      debtsSection.classList.remove('hidden');
      
      debtsList.innerHTML = debts.map(debt => {
        const paidAmount = debt.paidAmount || 0;
        const remaining = debt.totalDebt - paidAmount;
        const progress = (paidAmount / debt.totalDebt) * 100;
        const monthsRemaining = remaining > 0 && debt.monthlyPayment > 0 ? Math.ceil(remaining / debt.monthlyPayment) : 0;
        
        if (remaining <= 0) return '';
        
        return `
          <div class="border border-gray-200 rounded-lg p-5">
            <div class="flex justify-between items-start mb-4">
              <div class="flex-1">
                <h3 class="font-semibold text-gray-900 mb-1" style="font-size: ${(config.font_size || defaultConfig.font_size) * 1.14}px;">${debt.creditor}</h3>
                <p class="text-gray-500 text-sm">${debt.description}</p>
              </div>
              <button onclick="window.deleteTransaction('${debt.__backendId}')" class="text-gray-400 hover:text-gray-700 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            
            <div class="grid grid-cols-3 gap-3 mb-4 text-sm">
              <div>
                <p class="text-gray-500 text-xs mb-1">Total</p>
                <p class="text-gray-900 font-semibold">$${debt.totalDebt.toFixed(2)}</p>
              </div>
              <div>
                <p class="text-gray-500 text-xs mb-1">Mensual</p>
                <p class="text-gray-900 font-semibold">$${debt.monthlyPayment.toFixed(2)}</p>
              </div>
              <div>
                <p class="text-gray-500 text-xs mb-1">Restante</p>
                <p class="text-gray-900 font-semibold">$${remaining.toFixed(2)}</p>
              </div>
            </div>
            
            <div class="mb-4">
              <div class="flex justify-between text-xs mb-2">
                <span class="text-gray-600">${progress.toFixed(0)}% pagado</span>
                <span class="text-gray-500">${monthsRemaining} ${monthsRemaining === 1 ? 'mes' : 'meses'}</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="progress-bar bg-gray-700 h-2 rounded-full" style="width: ${progress}%"></div>
              </div>
            </div>
            
            <div class="flex gap-2">
              <button onclick="window.showPaymentOptions('${debt.__backendId}')" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white font-medium py-2 rounded-lg transition-colors text-sm">
                Hacer abono
              </button>
              <button onclick="window.payFullDebt('${debt.__backendId}')" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 rounded-lg transition-colors text-sm">
                Pagar todo
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function showPaymentOptions(backendId) {
      const debt = currentData.find(t => t.__backendId === backendId);
      if (!debt) return;
      
      const paidAmount = (debt.paidAmount || 0);
      const remaining = debt.totalDebt - paidAmount;
      
      if (remaining <= 0) {
        showToast('Esta deuda ya está completamente pagada', 'info');
        return;
      }
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4';
      modal.style.zIndex = '1002';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md fade-in">
          <div class="p-6 border-b border-gray-200">
            <h3 class="font-semibold text-gray-900 mb-1" style="font-size: 18px;">Hacer Abono</h3>
            <p class="text-gray-500 text-sm">${debt.creditor}</p>
          </div>
          <div class="p-6">
            <div class="mb-6">
              <div class="bg-gray-50 rounded-lg p-4 mb-4">
                <div class="flex justify-between text-sm mb-2">
                  <span class="text-gray-600">Deuda total:</span>
                  <span class="text-gray-900 font-semibold">$${debt.totalDebt.toFixed(2)}</span>
                </div>
                <div class="flex justify-between text-sm mb-2">
                  <span class="text-gray-600">Abonado:</span>
                  <span class="text-gray-900 font-semibold">$${paidAmount.toFixed(2)}</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">Restante:</span>
                  <span class="text-gray-900 font-semibold">$${remaining.toFixed(2)}</span>
                </div>
              </div>
              
              <label for="payment-amount" class="block text-gray-700 text-sm font-medium mb-2">Monto del abono ($)</label>
              <input type="number" id="payment-amount" step="0.01" min="0.01" max="${remaining}" value="${Math.min(debt.monthlyPayment, remaining)}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent text-sm mb-2">
              <p class="text-gray-500 text-xs">Cuota sugerida: $${debt.monthlyPayment.toFixed(2)}</p>
            </div>
            
            <div class="flex gap-3">
              <button id="confirm-payment-btn" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white font-medium py-2 rounded-lg transition-colors text-sm">
                Confirmar abono
              </button>
              <button id="cancel-payment-btn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 rounded-lg transition-colors text-sm">
                Cancelar
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('confirm-payment-btn').addEventListener('click', async () => {
        const amount = parseFloat(document.getElementById('payment-amount').value);
        
        if (!amount || amount <= 0) {
          showToast('Ingresa un monto válido', 'error');
          return;
        }
        
        if (amount > remaining) {
          showToast('El abono no puede ser mayor al monto restante', 'error');
          return;
        }
        
        if (currentData.length >= 998) {
          showToast('Has alcanzado el límite de 999 registros', 'error');
          return;
        }
        
        debt.paidAmount = (debt.paidAmount || 0) + amount;
        
        const expenseTransaction = {
          id: Date.now().toString() + '_payment',
          type: 'expense',
          description: `Abono - ${debt.creditor}`,
          amount: amount,
          category: 'Deudas',
          isRecurring: false,
          isTemplate: false,
          date: new Date().toISOString().split('T')[0],
          createdAt: new Date().toISOString(),
          debtPaymentId: debt.__backendId
        };
        
        modal.remove();
        showLoading();
        const updateResult = await window.dataSdk.update(debt);
        
        if (updateResult.isOk) {
          const createResult = await window.dataSdk.create(expenseTransaction);
          hideLoading();
          
          if (createResult.isOk) {
            showToast(`¡Abono de $${amount.toFixed(2)} registrado!`, 'success');
          } else {
            showToast('Abono actualizado pero no se pudo registrar el gasto', 'error');
          }
        } else {
          hideLoading();
          showToast('Error al registrar el abono', 'error');
        }
      });
      
      document.getElementById('cancel-payment-btn').addEventListener('click', () => {
        modal.remove();
      });
    }
    
    async function payFullDebt(backendId) {
      const debt = currentData.find(t => t.__backendId === backendId);
      if (!debt) return;
      
      const paidAmount = (debt.paidAmount || 0);
      const remaining = debt.totalDebt - paidAmount;
      
      if (remaining <= 0) {
        showToast('Esta deuda ya está completamente pagada', 'info');
        return;
      }
      
      if (currentData.length >= 998) {
        showToast('Has alcanzado el límite de 999 registros', 'error');
        return;
      }
      
      const confirmModal = document.createElement('div');
      confirmModal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4';
      confirmModal.style.zIndex = '1002';
      confirmModal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm fade-in p-6">
          <h3 class="font-semibold text-gray-900 mb-3" style="font-size: 18px;">Pago Total</h3>
          <p class="text-gray-700 mb-6">¿Deseas pagar el total de <strong>$${remaining.toFixed(2)}</strong> a <strong>${debt.creditor}</strong>?</p>
          <div class="flex gap-3">
            <button id="confirm-full-btn" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white font-medium py-2 rounded-lg transition-colors text-sm">
              Sí, pagar todo
            </button>
            <button id="cancel-full-btn" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 rounded-lg transition-colors text-sm">
              Cancelar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(confirmModal);
      
      document.getElementById('confirm-full-btn').addEventListener('click', async () => {
        debt.paidAmount = debt.totalDebt;
        
        const expenseTransaction = {
          id: Date.now().toString() + '_payment',
          type: 'expense',
          description: `Pago total - ${debt.creditor}`,
          amount: remaining,
          category: 'Deudas',
          isRecurring: false,
          isTemplate: false,
          date: new Date().toISOString().split('T')[0],
          createdAt: new Date().toISOString(),
          debtPaymentId: debt.__backendId
        };
        
        confirmModal.remove();
        showLoading();
        const updateResult = await window.dataSdk.update(debt);
        
        if (updateResult.isOk) {
          const createResult = await window.dataSdk.create(expenseTransaction);
          hideLoading();
          
          if (createResult.isOk) {
            showToast('¡Deuda pagada completamente!  ', 'success');
          } else {
            showToast('Deuda actualizada pero no se pudo registrar el gasto', 'error');
          }
        } else {
          hideLoading();
          showToast('Error al registrar el pago', 'error');
        }
      });
      
      document.getElementById('cancel-full-btn').addEventListener('click', () => {
        confirmModal.remove();
      });
    }

    function renderTransactions() {
      const list = document.getElementById('transactions-list');
      const emptyState = document.getElementById('empty-state');
      const config = window.elementSdk?.config || defaultConfig;
      
      const monthlyData = filterByMonth(currentData);
      const nonDebtTransactions = monthlyData.filter(t => t.type !== 'debt');
      
      if (nonDebtTransactions.length === 0) {
        list.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      
      const sortedData = [...nonDebtTransactions].sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
      
      list.innerHTML = sortedData.map(transaction => {
        const isIncome = transaction.type === 'income';
        const sign = isIncome ? '+' : '− ';
        const transactionDate = new Date(transaction.createdAt);
        const dateStr = transactionDate.toLocaleDateString('es-ES', { 
          day: 'numeric', 
          month: 'short', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const originalCurrency = transaction.originalCurrency || transaction.currency || '$';
        const currencyBadge = originalCurrency ? `<span class="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded font-medium">${originalCurrency}</span>` : '';
        let methodBadge = '';
        if (transaction.paymentSplits && transaction.paymentSplits.length > 0) {
          methodBadge = transaction.paymentSplits.map(s => `<span class="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded font-medium">${s.method || '?'} $${(s.amount || 0).toFixed(2)}</span>`).join(' ');
        } else if (transaction.paymentMethod) {
          methodBadge = `<span class="bg-gray-100 text-gray-600 text-xs px-2 py-0.5 rounded font-medium">${transaction.paymentMethod}</span>`;
        }
        
        let amountDisplay = `${sign}$${transaction.amount.toFixed(2)}`;
        if (originalCurrency === 'Bs' && transaction.originalAmount && transaction.bcvRate) {
          amountDisplay += ` <span class="text-gray-500 text-xs">(Bs ${transaction.originalAmount.toFixed(2)})</span>`;
        }
        
        const hasNotes = transaction.notes && transaction.notes.trim();
        const notesIcon = hasNotes ? `
          <button onclick="window.viewNotes('${transaction.__backendId}')" class="text-gray-400 hover:text-gray-600 transition-colors p-1" title="Ver notas">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"></path>
              <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"></path>
            </svg>
          </button>
        ` : '';
        
        return `
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-3 sm:p-4 border-b border-gray-100 hover:bg-gray-50 transition-colors gap-2 sm:gap-0">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1 flex-wrap">
                <h4 class="font-medium text-gray-900 text-sm sm:text-base break-words" style="font-size: ${(config.font_size || defaultConfig.font_size) * 1.07}px;">${transaction.description}</h4>
                ${currencyBadge}
                ${methodBadge}
              </div>
              <div class="flex items-center gap-2 sm:gap-3 flex-wrap">
                <p class="text-gray-500 text-xs">${transaction.category}</p>
                <span class="text-gray-300 text-xs hidden sm:inline"></span>
                <p class="text-gray-500 text-xs">${dateStr}</p>
              </div>
            </div>
            <div class="flex items-center justify-between sm:justify-end gap-3 sm:gap-4">
              <span class="font-semibold text-gray-900 text-base sm:text-lg" style="font-size: ${(config.font_size || defaultConfig.font_size) * 1.29}px;">${amountDisplay}</span>
              <div class="flex items-center gap-2">
                ${notesIcon}
                <button onclick="window.editTransaction('${transaction.__backendId}')" class="text-gray-400 hover:text-gray-600 transition-colors p-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                </button>
                <button onclick="window.deleteTransaction('${transaction.__backendId}')" class="text-gray-400 hover:text-gray-700 transition-colors p-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    window.viewNotes = viewNotes;
    window.deleteTransaction = deleteTransaction;
    window.editTransaction = editTransaction;
    window.showPaymentOptions = showPaymentOptions;
    window.payFullDebt = payFullDebt;

    function viewNotes(backendId) {
      const transaction = currentData.find(t => t.__backendId === backendId);
      if (!transaction || !transaction.notes) return;
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4';
      modal.style.zIndex = '1002';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md fade-in">
          <div class="p-6 border-b border-gray-200">
            <h3 class="font-semibold text-gray-900 mb-1" style="font-size: 18px;">Notas</h3>
            <p class="text-gray-500 text-sm">${transaction.description}</p>
          </div>
          <div class="p-6">
            <p class="text-gray-700 text-sm leading-relaxed whitespace-pre-wrap">${transaction.notes}</p>
            <button id="close-notes-btn" class="w-full mt-6 bg-gray-800 hover:bg-gray-700 text-white font-medium py-2 rounded-lg transition-colors text-sm">
              Cerrar
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('close-notes-btn').addEventListener('click', () => {
        modal.remove();
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    }

    async function deleteTransaction(backendId) {
      const transaction = currentData.find(t => t.__backendId === backendId);
      if (!transaction) return;
      
      if (transaction.type === 'expense' && transaction.debtPaymentId) {
        const debt = currentData.find(t => t.__backendId === transaction.debtPaymentId);
        if (debt && debt.paidAmount > 0) {
          debt.paidAmount = Math.max(0, (debt.paidAmount || 0) - transaction.amount);
          showLoading();
          await window.dataSdk.update(debt);
        }
      }
      
      showLoading();
      const result = await window.dataSdk.delete(transaction);
      hideLoading();
      
      if (!result.isOk) {
        showToast('Error al eliminar', 'error');
      } else {
        showToast('Eliminado correctamente', 'success');
      }
    }

    function showModal(type, isTemplate = false) {
      editingTransaction = null;
      currentTransactionType = type;
      isTemplateMode = isTemplate;
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modal-title');
      const submitBtnText = document.getElementById('submit-btn-text');
      const categorySelect = document.getElementById('category');
      const categoryField = document.getElementById('category-field');
      const scheduledDayField = document.getElementById('scheduled-day-field-main');
      const paymentFrequencyField = document.getElementById('payment-frequency-field');
      const creditorField = document.getElementById('creditor-field');
      const totalDebtField = document.getElementById('total-debt-field');
      const amountLabel = document.getElementById('amount-label');
      const currencyField = document.getElementById('currency-field');
      const paymentMethodField = document.getElementById('payment-method-field');
      const currencyLabel = document.getElementById('currency-label');
      const notesField = document.getElementById('notes-field');
      const conversionPreview = document.getElementById('conversion-preview');
      
      submitBtnText.textContent = 'Guardar';
      conversionPreview.classList.add('hidden');
      
      if (type === 'income') {
        currencyLabel.textContent = '¿En qué moneda lo recibiste?';
      } else if (type === 'expense') {
        currencyLabel.textContent = '¿En qué moneda lo pagaste?';
      }
      
      if (type === 'debt') {
        modalTitle.textContent = 'Agregar Deuda';
        categoryField.classList.add('hidden');
        scheduledDayField.classList.add('hidden');
        paymentFrequencyField.classList.add('hidden');
        creditorField.classList.remove('hidden');
        totalDebtField.classList.remove('hidden');
        currencyField.classList.add('hidden');
        paymentMethodField.classList.add('hidden');
        notesField.classList.add('hidden');
        amountLabel.textContent = 'Pago Mensual Sugerido';
        document.getElementById('creditor').required = true;
        document.getElementById('total-debt').required = true;
        document.getElementById('category').required = false;
        document.getElementById('payment-method').required = false;
        document.getElementById('scheduled-day-main').required = false;
      } else {
        if (isTemplate) {
          modalTitle.textContent = type === 'income' ? 'Nueva Transacción Programada - Ingreso' : 'Nueva Transacción Programada - Gasto';
          paymentFrequencyField.classList.remove('hidden');
          currencyField.classList.remove('hidden');
          paymentMethodField.classList.remove('hidden');
          notesField.classList.remove('hidden');
          
          const freqSelect = document.getElementById('payment-frequency');
          freqSelect.addEventListener('change', function() {
            if (this.value === 'biweekly') {
              scheduledDayField.classList.add('hidden');
              document.getElementById('scheduled-day-main').required = false;
              document.getElementById('amount').placeholder = 'Monto total mensual';
            } else {
              scheduledDayField.classList.remove('hidden');
              document.getElementById('scheduled-day-main').required = true;
              document.getElementById('amount').placeholder = '0.00';
            }
          });
          
          if (document.getElementById('payment-frequency').value === 'single') {
            scheduledDayField.classList.remove('hidden');
            document.getElementById('scheduled-day-main').required = true;
          }
        } else {
          modalTitle.textContent = type === 'income' ? 'Agregar Ingreso' : 'Agregar Gasto';
          scheduledDayField.classList.add('hidden');
          paymentFrequencyField.classList.add('hidden');
          currencyField.classList.remove('hidden');
          paymentMethodField.classList.remove('hidden');
          notesField.classList.remove('hidden');
          document.getElementById('scheduled-day-main').required = false;
          document.getElementById('split-payment-toggle').classList.remove('hidden');
        }
        
        categoryField.classList.remove('hidden');
        creditorField.classList.add('hidden');
        totalDebtField.classList.add('hidden');
        amountLabel.textContent = isTemplate && document.getElementById('payment-frequency').value === 'biweekly' ? 'Monto Total Mensual' : 'Monto';
        document.getElementById('creditor').required = false;
        document.getElementById('total-debt').required = false;
        document.getElementById('category').required = true;
        document.getElementById('payment-method').required = true;
        
        const categories = type === 'income' ? incomeCategories : expenseCategories;
        categorySelect.innerHTML = '<option value="">Seleccionar...</option>' + 
          categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
      }
      if (isTemplate) document.getElementById('split-payment-toggle').classList.add('hidden');
      refreshPaymentMethodSelect('payment-method');
      
      document.getElementById('description').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('category').value = '';
      document.getElementById('creditor').value = '';
      document.getElementById('total-debt').value = '';
      document.getElementById('scheduled-day-main').value = '';
      document.getElementById('payment-frequency').value = 'single';
      document.getElementById('currency').value = '$';
      document.getElementById('payment-method').value = '';
      document.getElementById('notes').value = '';
      document.getElementById('split-payment-checkbox').checked = false;
      document.getElementById('payment-splits-container').classList.add('hidden');
      document.getElementById('payment-splits-list').innerHTML = '';
      refreshPaymentMethodSelect('payment-method');
      
      // Set default date to today
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      document.getElementById('transaction-date').value = `${year}-${month}-${day}`;
      
      // Show/hide date field based on template mode
      const dateField = document.getElementById('date-field');
      if (isTemplate) {
        dateField.classList.add('hidden');
        document.getElementById('transaction-date').required = false;
      } else {
        dateField.classList.remove('hidden');
        document.getElementById('transaction-date').required = true;
      }
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function editTransaction(backendId) {
      const transaction = currentData.find(t => t.__backendId === backendId);
      if (!transaction) return;
      
      editingTransaction = JSON.parse(JSON.stringify(transaction));
      editingTransaction.__backendId = transaction.__backendId;
      
      currentTransactionType = transaction.type;
      isTemplateMode = transaction.isTemplate || false;
      
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modal-title');
      const submitBtnText = document.getElementById('submit-btn-text');
      const categorySelect = document.getElementById('category');
      const categoryField = document.getElementById('category-field');
      const scheduledDayField = document.getElementById('scheduled-day-field-main');
      const paymentFrequencyField = document.getElementById('payment-frequency-field');
      const creditorField = document.getElementById('creditor-field');
      const totalDebtField = document.getElementById('total-debt-field');
      const amountLabel = document.getElementById('amount-label');
      const currencyField = document.getElementById('currency-field');
      const paymentMethodField = document.getElementById('payment-method-field');
      const currencyLabel = document.getElementById('currency-label');
      const notesField = document.getElementById('notes-field');
      const conversionPreview = document.getElementById('conversion-preview');
      
      submitBtnText.textContent = 'Actualizar';
      conversionPreview.classList.add('hidden');
      
      if (transaction.type === 'income') {
        currencyLabel.textContent = '¿En qué moneda lo recibiste?';
      } else if (transaction.type === 'expense') {
        currencyLabel.textContent = '¿En qué moneda lo pagaste?';
      }
      
      document.getElementById('description').value = transaction.description;
      const originalAmount = transaction.originalAmount || transaction.amount;
      document.getElementById('amount').value = originalAmount;
      document.getElementById('notes').value = transaction.notes || '';
      
      // Set transaction date
      const transactionDate = new Date(transaction.createdAt);
      const year = transactionDate.getFullYear();
      const month = String(transactionDate.getMonth() + 1).padStart(2, '0');
      const day = String(transactionDate.getDate()).padStart(2, '0');
      document.getElementById('transaction-date').value = `${year}-${month}-${day}`;
      
      // Show/hide date field
      const dateField = document.getElementById('date-field');
      if (isTemplateMode) {
        dateField.classList.add('hidden');
        document.getElementById('transaction-date').required = false;
      } else {
        dateField.classList.remove('hidden');
        document.getElementById('transaction-date').required = true;
      }
      
      if (transaction.type === 'debt') {
        modalTitle.textContent = 'Editar Deuda';
        categoryField.classList.add('hidden');
        scheduledDayField.classList.add('hidden');
        paymentFrequencyField.classList.add('hidden');
        creditorField.classList.remove('hidden');
        totalDebtField.classList.remove('hidden');
        currencyField.classList.add('hidden');
        paymentMethodField.classList.add('hidden');
        notesField.classList.add('hidden');
        dateField.classList.add('hidden');
        amountLabel.textContent = 'Pago Mensual Sugerido';
        document.getElementById('creditor').required = true;
        document.getElementById('total-debt').required = true;
        document.getElementById('category').required = false;
        document.getElementById('payment-method').required = false;
        document.getElementById('scheduled-day-main').required = false;
        document.getElementById('transaction-date').required = false;
        
        document.getElementById('creditor').value = transaction.creditor || '';
        document.getElementById('total-debt').value = transaction.totalDebt || '';
      } else {
        if (isTemplateMode) {
          modalTitle.textContent = transaction.type === 'income' ? 'Editar Transacción Programada - Ingreso' : 'Editar Transacción Programada - Gasto';
          paymentFrequencyField.classList.remove('hidden');
          currencyField.classList.remove('hidden');
          paymentMethodField.classList.remove('hidden');
          notesField.classList.remove('hidden');
          
          const freqSelect = document.getElementById('payment-frequency');
          freqSelect.value = transaction.isBiweekly ? 'biweekly' : 'single';
          
          freqSelect.addEventListener('change', function() {
            if (this.value === 'biweekly') {
              scheduledDayField.classList.add('hidden');
              document.getElementById('scheduled-day-main').required = false;
              document.getElementById('amount').placeholder = 'Monto total mensual';
            } else {
              scheduledDayField.classList.remove('hidden');
              document.getElementById('scheduled-day-main').required = true;
              document.getElementById('amount').placeholder = '0.00';
            }
          });
          
          if (transaction.isBiweekly) {
            scheduledDayField.classList.add('hidden');
            document.getElementById('scheduled-day-main').required = false;
          } else {
            scheduledDayField.classList.remove('hidden');
            document.getElementById('scheduled-day-main').required = true;
            document.getElementById('scheduled-day-main').value = transaction.scheduledDay || '';
          }
        } else {
          modalTitle.textContent = transaction.type === 'income' ? 'Editar Ingreso' : 'Editar Gasto';
          scheduledDayField.classList.add('hidden');
          paymentFrequencyField.classList.add('hidden');
          currencyField.classList.remove('hidden');
          paymentMethodField.classList.remove('hidden');
          notesField.classList.remove('hidden');
          document.getElementById('scheduled-day-main').required = false;
        }
        
        categoryField.classList.remove('hidden');
        creditorField.classList.add('hidden');
        totalDebtField.classList.add('hidden');
        amountLabel.textContent = isTemplateMode && transaction.isBiweekly ? 'Monto Total Mensual' : 'Monto';
        document.getElementById('creditor').required = false;
        document.getElementById('total-debt').required = false;
        document.getElementById('category').required = true;
        document.getElementById('payment-method').required = true;
        
        const categories = transaction.type === 'income' ? incomeCategories : expenseCategories;
        categorySelect.innerHTML = '<option value="">Seleccionar...</option>' + 
          categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        
        document.getElementById('category').value = transaction.category || '';
        const originalCurrency = transaction.originalCurrency || transaction.currency || '$';
        document.getElementById('currency').value = originalCurrency;
        document.getElementById('payment-method').value = transaction.paymentMethod || '';
        
        const hasSplits = transaction.paymentSplits && transaction.paymentSplits.length > 0;
        document.getElementById('split-payment-checkbox').checked = hasSplits;
        const container = document.getElementById('payment-splits-container');
        const list = document.getElementById('payment-splits-list');
        list.innerHTML = '';
        if (hasSplits) {
          container.classList.remove('hidden');
          const rate = transaction.bcvRate || currentBcvRate || 1;
          transaction.paymentSplits.forEach(s => {
            addSplitRow();
            const lastRow = list.lastElementChild;
            if (lastRow) {
              lastRow.querySelector('.split-method-select').value = s.method || '';
              const displayAmount = originalCurrency === 'Bs' && rate ? (s.amount * rate) : s.amount;
              lastRow.querySelector('.split-amount-input').value = displayAmount.toFixed(2);
            }
          });
          updateSplitsTotal();
        } else {
          container.classList.add('hidden');
        }
        
        updateConversionPreview();
      }
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function hideModal() {
      const modal = document.getElementById('modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

    function showToast(message, type) {
      const colors = {
        error: 'bg-gray-700',
        success: 'bg-gray-800',
        info: 'bg-gray-600'
      };
      const toast = document.createElement('div');
      toast.className = `fixed top-6 right-6 px-4 py-3 rounded-lg shadow-lg ${colors[type] || colors.success} text-white text-sm font-medium fade-in`;
      toast.style.zIndex = '10000';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    document.getElementById('add-income-btn').addEventListener('click', () => showModal('income', false));
    document.getElementById('add-expense-btn').addEventListener('click', () => showModal('expense', false));
    document.getElementById('add-debt-btn').addEventListener('click', () => showModal('debt', false));
    document.getElementById('cancel-btn').addEventListener('click', hideModal);
    document.getElementById('config-btn').addEventListener('click', showConfigModal);
    document.getElementById('close-config-btn').addEventListener('click', hideConfigModal);

    document.getElementById('add-payment-method-btn').addEventListener('click', function() {
      const input = document.getElementById('new-payment-method-input');
      const name = (input.value || '').trim();
      if (!name) { showToast('Escribe el nombre del método', 'error'); return; }
      addPaymentMethod(name);
      refreshAllPaymentMethodSelects();
      input.value = '';
      showToast('Método agregado', 'success');
    });

    document.getElementById('split-payment-checkbox').addEventListener('change', function() {
      const container = document.getElementById('payment-splits-container');
      const list = document.getElementById('payment-splits-list');
      if (this.checked) {
        container.classList.remove('hidden');
        if (list.children.length === 0) addSplitRow();
        updateSplitsTotal();
      } else {
        container.classList.add('hidden');
        list.innerHTML = '';
      }
    });
    document.getElementById('add-split-row-btn').addEventListener('click', function() {
      addSplitRow();
      updateSplitsTotal();
    });

    function addSplitRow() {
      const list = document.getElementById('payment-splits-list');
      const methods = getPaymentMethods();
      const row = document.createElement('div');
      row.className = 'flex gap-2 items-center split-row';
      row.innerHTML = `
        <select class="split-method-select flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
          <option value="">Método...</option>
          ${methods.map(m => `<option value="${m}">${m}</option>`).join('')}
        </select>
        <input type="number" step="0.01" min="0" class="split-amount-input w-24 px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="0">
        <button type="button" class="remove-split-row text-gray-500 hover:text-red-600 font-bold px-1">×</button>
      `;
      row.querySelector('.remove-split-row').addEventListener('click', function() {
        row.remove();
        updateSplitsTotal();
      });
      row.querySelector('.split-amount-input').addEventListener('input', updateSplitsTotal);
      list.appendChild(row);
    }
    function updateSplitsTotal() {
      let sum = 0;
      document.querySelectorAll('.split-amount-input').forEach(inp => { sum += parseFloat(inp.value) || 0; });
      const mainAmount = parseFloat(document.getElementById('amount').value) || 0;
      const el = document.getElementById('payment-splits-total');
      el.textContent = 'Total: $' + sum.toFixed(2) + (mainAmount > 0 && Math.abs(sum - mainAmount) > 0.01 ? ' (debe ser $' + mainAmount.toFixed(2) + ')' : '');
      el.style.color = mainAmount > 0 && Math.abs(sum - mainAmount) > 0.01 ? '#b91c1c' : '#374151';
    }
    function getPaymentSplitsFromForm() {
      const rows = document.querySelectorAll('.split-row');
      const selectedCurrency = document.getElementById('currency').value;
      const rateForDate = document.getElementById('historical-rate-input').value ? parseFloat(document.getElementById('historical-rate-input').value) : currentBcvRate;
      const mainAmountRaw = parseFloat(document.getElementById('amount').value) || 0;
      const totalInDollars = selectedCurrency === 'Bs' && rateForDate ? mainAmountRaw / rateForDate : mainAmountRaw;
      const splits = [];
      let sum = 0;
      rows.forEach(row => {
        const method = (row.querySelector('.split-method-select') || {}).value;
        const raw = parseFloat(row.querySelector('.split-amount-input').value) || 0;
        const amountDollars = selectedCurrency === 'Bs' && rateForDate ? raw / rateForDate : raw;
        if (method && amountDollars > 0) {
          splits.push({ method, amount: amountDollars });
          sum += amountDollars;
        }
      });
      if (splits.length === 0) return null;
      if (Math.abs(sum - totalInDollars) > 0.01) return null;
      return splits;
    }


    window._dataFileHandle = null;
    window._persistToFile = function() {
      if (!window._dataFileHandle) return;
      var raw = localStorage.getItem('miguelini_data') || '[]';
      window._dataFileHandle.createWritable().then(function(w) {
        w.write(raw);
        w.close();
      }).catch(function() { window._dataFileHandle = null; });
    };
    function setFileStatus(msg) {
      var el = document.getElementById('file-status');
      el.textContent = msg;
    }
    function updateFileStatus() {
      setFileStatus(window._dataFileHandle ? 'Guardando en archivo en cada cambio.' : 'Ningún archivo seleccionado. Abre uno o «Guardar como archivo nuevo».');
    }
    document.getElementById('open-file-btn').addEventListener('click', function() {
      if (!window.showOpenFilePicker) { setFileStatus('Tu navegador no soporta elegir archivos. Usa Chrome o Edge.'); return; }
      window.showOpenFilePicker({ types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }], multiple: false })
        .then(function([handle]) {
          return handle.getFile().then(function(f) { return f.text().then(function(t) { return { handle: handle, text: t }; }); });
        })
        .then(function(r) {
          var arr = JSON.parse(r.text);
          if (!Array.isArray(arr)) throw new Error('El archivo debe contener un array JSON');
          localStorage.setItem('miguelini_data', JSON.stringify(arr));
          window._dataFileHandle = r.handle;
          window.dataSdk._store = arr;
          if (window.dataSdk._handler && window.dataSdk._handler.onDataChanged) window.dataSdk._handler.onDataChanged(arr);
          setFileStatus('Archivo cargado. Los cambios se guardarán aquí.');
          updateUI();
        })
        .catch(function(e) {
          if (e.name !== 'AbortError') setFileStatus('Error: ' + (e.message || e));
        });
    });
    document.getElementById('save-file-btn').addEventListener('click', function() {
      if (!window.showSaveFilePicker) { setFileStatus('Tu navegador no soporta guardar archivo. Usa Chrome o Edge.'); return; }
      window.showSaveFilePicker({ suggestedName: 'miguelini-datos.json', types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }] })
        .then(function(handle) {
          window._dataFileHandle = handle;
          return handle.createWritable().then(function(w) {
            w.write(localStorage.getItem('miguelini_data') || '[]');
            w.close();
          });
        })
        .then(function() {
          setFileStatus('Archivo guardado. A partir de ahora cada cambio se guardará aquí.');
        })
        .catch(function(e) {
          if (e.name !== 'AbortError') setFileStatus('Error: ' + (e.message || e));
        });
    });
    document.getElementById('save-csv-file-btn').addEventListener('click', function() {
      if (!window.showSaveFilePicker) { setFileStatus('Tu navegador no soporta guardar archivo. Usa Chrome o Edge.'); return; }
      var data = JSON.parse(localStorage.getItem('miguelini_data') || '[]');
      var headers = ['tipo', 'descripcion', 'monto', 'categoria', 'fecha', 'metodo_pago', 'notas', 'acreedor', 'deuda_total', 'pago_mensual', 'pagado'];
      var rows = [headers.join(',')];
      data.forEach(function(t) {
        var date = t.date || (t.createdAt || '').split('T')[0] || '';
        rows.push([
          (t.type || ''),
          '"' + (t.description || '').replace(/"/g, '""') + '"',
          t.amount != null ? t.amount : '',
          '"' + (t.category || '').replace(/"/g, '""') + '"',
          date,
          '"' + (t.paymentMethod || '').replace(/"/g, '""') + '"',
          '"' + (t.notes || '').replace(/"/g, '""') + '"',
          '"' + (t.creditor || '').replace(/"/g, '""') + '"',
          t.totalDebt != null ? t.totalDebt : '',
          t.monthlyPayment != null ? t.monthlyPayment : '',
          t.paidAmount != null ? t.paidAmount : ''
        ].join(','));
      });
      var csv = '\ufeff' + rows.join('\r\n');
      window.showSaveFilePicker({ suggestedName: 'miguelini-datos.csv', types: [{ description: 'CSV', accept: { 'text/csv': ['.csv'] } }] })
        .then(function(handle) {
          return handle.createWritable().then(function(w) {
            w.write(csv);
            w.close();
          });
        })
        .then(function() {
          setFileStatus('CSV guardado en tu PC. Para seguir usando el archivo como respaldo, usa «Guardar como archivo nuevo» (JSON).');
        })
        .catch(function(e) {
          if (e.name !== 'AbortError') setFileStatus('Error: ' + (e.message || e));
        });
    });
    document.getElementById('export-data-btn').addEventListener('click', function() {
      var raw = localStorage.getItem('miguelini_data') || '[]';
      var blob = new Blob([raw], { type: 'application/json' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'miguelini-datos-' + new Date().toISOString().slice(0, 10) + '.json';
      a.click();
      URL.revokeObjectURL(a.href);
      showToast('Descarga iniciada', 'success');
    });
    document.getElementById('copy-data-btn').addEventListener('click', function() {
      var raw = localStorage.getItem('miguelini_data') || '[]';
      navigator.clipboard.writeText(raw).then(function() { showToast('Copiado al portapapeles', 'success'); }).catch(function() { showToast('No se pudo copiar', 'error'); });
    });
    document.getElementById('import-data-btn').addEventListener('click', function() {
      var text = document.getElementById('import-json-input').value.trim();
      if (!text) { showToast('Pega el JSON antes de importar', 'error'); return; }
      try {
        var parsed = JSON.parse(text);
        var arr = Array.isArray(parsed) ? parsed : (parsed.data || parsed.items || parsed.transactions || (typeof parsed === 'object' && Object.keys(parsed).length === 1 ? Object.values(parsed)[0] : null));
        if (!Array.isArray(arr)) { showToast('El JSON debe ser un array o un objeto con data/items/transactions', 'error'); return; }
        localStorage.setItem('miguelini_data', JSON.stringify(arr));
        showToast('Datos importados. Recargando...', 'success');
        setTimeout(function() { location.reload(); }, 800);
      } catch (e) {
        showToast('JSON inválido: ' + e.message, 'error');
      }
    });

    var sheetUrlInput = document.getElementById('google-sheet-url');
    var sheetStatus = document.getElementById('sheet-status');
    if (localStorage.getItem('miguelini_sheet_url')) sheetUrlInput.value = localStorage.getItem('miguelini_sheet_url');
    sheetUrlInput.addEventListener('change', function() {
      var v = (this.value || '').trim();
      localStorage.setItem('miguelini_sheet_url', v);
      window._sheetSyncUrl = v || null;
    });
    function setSheetStatus(msg, isError) {
      sheetStatus.textContent = msg;
      sheetStatus.classList.remove('hidden');
      sheetStatus.style.color = isError ? '#b91c1c' : '#15803d';
    }
    document.getElementById('send-to-sheet-btn').addEventListener('click', function() {
      var url = sheetUrlInput.value.trim();
      if (!url) { setSheetStatus('Escribe la URL del Web App de Google.', true); return; }
      localStorage.setItem('miguelini_sheet_url', url);
      window._sheetSyncUrl = url;
      var data = localStorage.getItem('miguelini_data') || '[]';
      setSheetStatus('Enviando...', false);
      fetch(url, { method: 'POST', body: data, headers: { 'Content-Type': 'application/json' } })
        .then(function(r) { return r.json(); })
        .then(function(res) {
          if (res && res.ok) setSheetStatus('Enviado correctamente. ' + (res.count != null ? res.count + ' registros.' : ''), false);
          else setSheetStatus(res && res.error ? res.error : 'Error en el servidor.', true);
        })
        .catch(function(err) {
          setSheetStatus('Error de red o CORS. Usa «Descargar CSV» e impórtalo en el Sheet (Archivo → Importar).', true);
        });
    });
    document.getElementById('copy-mobile-link-btn').addEventListener('click', function() {
      var url = (sheetUrlInput.value || '').trim();
      if (!url) { setSheetStatus('Pega primero la URL del Web App arriba.', true); return; }
      var base = window.location.origin + (window.location.pathname || '/');
      var sep = base.indexOf('?') >= 0 ? '&' : '?';
      var link = base + sep + 'sheet=' + encodeURIComponent(url);
      navigator.clipboard.writeText(link).then(function() { showToast('Enlace copiado. Ábrelo en el móvil para ver los mismos datos.', 'success'); }).catch(function() { setSheetStatus('No se pudo copiar. Enlace: ' + link, false); });
    });
    document.getElementById('fetch-from-sheet-btn').addEventListener('click', function() {
      var url = sheetUrlInput.value.trim();
      if (!url) { setSheetStatus('Escribe la URL del Web App.', true); return; }
      localStorage.setItem('miguelini_sheet_url', url);
      window._sheetSyncUrl = url;
      setSheetStatus('Trayendo...', false);
      fetch(url).then(function(r) { return r.json(); }).then(function(arr) {
        if (!Array.isArray(arr)) { setSheetStatus('El Sheet no devolvió un array. Revisa el script.', true); return; }
        localStorage.setItem('miguelini_data', JSON.stringify(arr));
        setSheetStatus('Datos cargados. Recargando...', false);
        setTimeout(function() { location.reload(); }, 800);
      }).catch(function(err) {
        setSheetStatus('Error al traer (CORS o URL). Prueba con la extensión CORS o importa el JSON manual.', true);
      });
    });
    document.getElementById('export-csv-btn').addEventListener('click', function() {
      var raw = localStorage.getItem('miguelini_data') || '[]';
      var data = JSON.parse(raw);
      var headers = ['tipo', 'descripcion', 'monto', 'categoria', 'fecha', 'metodo_pago', 'notas', 'acreedor', 'deuda_total', 'pago_mensual', 'pagado'];
      var rows = [headers.join(',')];
      data.forEach(function(t) {
        var date = (t.date || (t.createdAt || '').split('T')[0] || '');
        rows.push([
          (t.type || ''),
          '"' + (t.description || '').replace(/"/g, '""') + '"',
          t.amount != null ? t.amount : '',
          '"' + (t.category || '').replace(/"/g, '""') + '"',
          date,
          '"' + (t.paymentMethod || '').replace(/"/g, '""') + '"',
          '"' + (t.notes || '').replace(/"/g, '""') + '"',
          '"' + (t.creditor || '').replace(/"/g, '""') + '"',
          t.totalDebt != null ? t.totalDebt : '',
          t.monthlyPayment != null ? t.monthlyPayment : '',
          t.paidAmount != null ? t.paidAmount : ''
        ].join(','));
      });
      var csv = '\ufeff' + rows.join('\r\n');
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'miguelini-datos-' + new Date().toISOString().slice(0, 10) + '.csv';
      a.click();
      URL.revokeObjectURL(a.href);
      setSheetStatus('CSV descargado. Impórtalo en Google Sheet: Archivo → Importar → Subir → Selecciona el archivo.', false);
    });
    document.getElementById('add-template-btn').addEventListener('click', () => {
      hideConfigModal();
      
      const confirmModal = document.createElement('div');
      confirmModal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4';
      confirmModal.style.zIndex = '1002';
      confirmModal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm fade-in p-6">
          <h3 class="font-semibold text-gray-900 mb-4" style="font-size: 18px;">¿Qué tipo de transacción programada?</h3>
          <div class="space-y-3">
            <button id="template-income-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-medium py-3 rounded-lg transition-colors">
              Ingreso Recurrente
            </button>
            <button id="template-expense-btn" class="w-full bg-gray-800 hover:bg-gray-700 text-white font-medium py-3 rounded-lg transition-colors">
              Gasto Recurrente
            </button>
            <button id="template-cancel-btn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 rounded-lg transition-colors">
              Cancelar
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmModal);
      
      document.getElementById('template-income-btn').addEventListener('click', () => {
        confirmModal.remove();
        showModal('income', true);
      });
      
      document.getElementById('template-expense-btn').addEventListener('click', () => {
        confirmModal.remove();
        showModal('expense', true);
      });
      
      document.getElementById('template-cancel-btn').addEventListener('click', () => {
        confirmModal.remove();
        showConfigModal();
      });
    });
    
    document.getElementById('currency').addEventListener('change', updateConversionPreview);
    document.getElementById('amount').addEventListener('input', function() { updateConversionPreview(); updateSplitsTotal(); });
    document.getElementById('transaction-date').addEventListener('change', updateConversionPreview);
    document.getElementById('historical-rate-input').addEventListener('input', updateConversionPreview);
    
    document.getElementById('prev-month-btn').addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      updateUI();
    });
    
    document.getElementById('next-month-btn').addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      updateUI();
    });

    document.getElementById('transaction-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!editingTransaction && currentData.length >= 999) {
        showToast('Has alcanzado el límite de 999 registros', 'error');
        return;
      }
      
      const description = document.getElementById('description').value;
      const inputAmount = parseFloat(document.getElementById('amount').value);
      const notes = document.getElementById('notes').value.trim();
      
      // Get selected date
      const selectedDateStr = document.getElementById('transaction-date').value;
      const selectedDate = selectedDateStr ? new Date(selectedDateStr + 'T12:00:00') : new Date();
      
      // Get currency FIRST
      const selectedCurrency = document.getElementById('currency').value;
      
      // Check if date is in the past and currency is Bs
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const checkDate = new Date(selectedDate);
      checkDate.setHours(0, 0, 0, 0);
      
      const isPastDate = checkDate < today;
      const needsHistoricalRate = selectedCurrency === 'Bs' && isPastDate && !isTemplateMode;
      
      let rateForDate = currentBcvRate;
      
      // Get historical rate from input if needed
      if (needsHistoricalRate) {
        const historicalRateInput = document.getElementById('historical-rate-input');
        const historicalRate = parseFloat(historicalRateInput.value);
        
        if (!historicalRate || historicalRate <= 0) {
          showToast('Por favor ingresa una tasa BCV válida para esa fecha', 'error');
          historicalRateInput.focus();
          return;
        }
        
        rateForDate = historicalRate;
      }
      
      if (editingTransaction) {
        editingTransaction.description = description;
        editingTransaction.notes = notes;
        
        // Update date if not template
        if (!isTemplateMode) {
          editingTransaction.date = selectedDate.toISOString().split('T')[0];
          editingTransaction.createdAt = selectedDate.toISOString();
        }
        
        if (currentTransactionType === 'debt') {
          editingTransaction.amount = inputAmount;
          editingTransaction.creditor = document.getElementById('creditor').value;
          editingTransaction.totalDebt = parseFloat(document.getElementById('total-debt').value);
          editingTransaction.monthlyPayment = inputAmount;
        } else {
          let amountInDollars = inputAmount;
          
          if (selectedCurrency === 'Bs' && rateForDate) {
            amountInDollars = inputAmount / rateForDate;
          }
          
          editingTransaction.amount = amountInDollars;
          editingTransaction.originalAmount = inputAmount;
          editingTransaction.originalCurrency = selectedCurrency;
          editingTransaction.bcvRate = rateForDate;
          editingTransaction.category = document.getElementById('category').value;
          editingTransaction.currency = selectedCurrency;
          const useSplit = document.getElementById('split-payment-checkbox').checked;
          if (useSplit) {
            const splits = getPaymentSplitsFromForm();
            if (splits) {
              editingTransaction.paymentSplits = splits;
              editingTransaction.paymentMethod = '';
            } else {
              showToast('El total de los métodos debe coincidir con el monto', 'error');
              return;
            }
          } else {
            editingTransaction.paymentMethod = document.getElementById('payment-method').value;
            editingTransaction.paymentSplits = null;
          }
          
          if (isTemplateMode) {
            const frequency = document.getElementById('payment-frequency').value;
            
            if (frequency === 'biweekly') {
              editingTransaction.isBiweekly = true;
              editingTransaction.scheduledDay = 15;
            } else {
              editingTransaction.isBiweekly = false;
              const scheduledDay = parseInt(document.getElementById('scheduled-day-main').value);
              if (!scheduledDay || scheduledDay < 1 || scheduledDay > 31) {
                showToast('Por favor ingresa un día válido (1-31)', 'error');
                return;
              }
              editingTransaction.scheduledDay = scheduledDay;
            }
          }
        }
        
        showLoading();
        const result = await window.dataSdk.update(editingTransaction);
        hideLoading();
        
        if (result.isOk) {
          hideModal();
          showToast('Actualizado correctamente ✓ ', 'success');
          if (isTemplateMode) {
            showConfigModal();
          }
        } else {
          showToast('Error al actualizar', 'error');
        }
      } else {
        let transaction = {
          id: Date.now().toString(),
          type: currentTransactionType,
          description,
          date: selectedDate.toISOString().split('T')[0],
          createdAt: selectedDate.toISOString(),
          isTemplate: isTemplateMode,
          notes: notes
        };
        
        if (currentTransactionType === 'debt') {
          const creditor = document.getElementById('creditor').value;
          const totalDebt = parseFloat(document.getElementById('total-debt').value);
          transaction.amount = inputAmount;
          transaction.creditor = creditor;
          transaction.totalDebt = totalDebt;
          transaction.monthlyPayment = inputAmount;
          transaction.paidMonths = 0;
          transaction.category = 'Deuda';
          transaction.isRecurring = false;
          transaction.isTemplate = false;
        } else {
          const category = document.getElementById('category').value;
          let amountInDollars = inputAmount;
          if (selectedCurrency === 'Bs' && rateForDate) {
            amountInDollars = inputAmount / rateForDate;
          }
          const useSplit = document.getElementById('split-payment-checkbox').checked;
          if (useSplit) {
            const splits = getPaymentSplitsFromForm();
            if (!splits) {
              showToast('El total de los métodos debe coincidir con el monto', 'error');
              return;
            }
            transaction.paymentSplits = splits;
            transaction.paymentMethod = '';
          } else {
            transaction.paymentMethod = document.getElementById('payment-method').value;
          }
          
          transaction.amount = amountInDollars;
          transaction.originalAmount = inputAmount;
          transaction.originalCurrency = selectedCurrency;
          transaction.bcvRate = rateForDate;
          transaction.category = category;
          transaction.isRecurring = false;
          transaction.currency = selectedCurrency;
          
          if (isTemplateMode) {
            const frequency = document.getElementById('payment-frequency').value;
            
            if (frequency === 'biweekly') {
              transaction.isBiweekly = true;
              transaction.scheduledDay = 15;
            } else {
              transaction.isBiweekly = false;
              const scheduledDay = parseInt(document.getElementById('scheduled-day-main').value);
              if (!scheduledDay || scheduledDay < 1 || scheduledDay > 31) {
                showToast('Por favor ingresa un día válido (1-31)', 'error');
                return;
              }
              transaction.scheduledDay = scheduledDay;
            }
          }
        }
        
        showLoading();
        const result = await window.dataSdk.create(transaction);
        hideLoading();
        
        if (result.isOk) {
          hideModal();
          if (isTemplateMode) {
            showToast('Transacción programada creada ✓ ', 'success');
            showConfigModal();
            
            await checkAndProcessScheduledTransactions();
          } else {
            showToast('Guardado correctamente ✓ ', 'success');
          }
        } else {
          showToast('Error al guardar', 'error');
        }
      }
    });

    async function init() {
      var sheetUrl = localStorage.getItem('miguelini_sheet_url') || '';
      var params = new URLSearchParams(window.location.search);
      var hash = (window.location.hash || '').replace(/^#/, '');
      if (params.get('sheet')) { sheetUrl = params.get('sheet'); localStorage.setItem('miguelini_sheet_url', sheetUrl); if (history.replaceState) history.replaceState(null, '', window.location.pathname + (window.location.hash || '')); }
      if (hash.indexOf('sheet=') === 0) { sheetUrl = decodeURIComponent(hash.slice(6).split('&')[0]); localStorage.setItem('miguelini_sheet_url', sheetUrl); if (history.replaceState) history.replaceState(null, '', window.location.pathname); }
      window._sheetSyncUrl = sheetUrl || null;
      if (sheetUrl) {
        try {
          var r = await fetch(sheetUrl);
          var arr = await r.json();
          if (Array.isArray(arr)) {
            localStorage.setItem('miguelini_data', JSON.stringify(arr));
          }
        } catch (e) { console.warn('No se pudo cargar desde Google Sheet', e); }
      }
      window._persistToSheet = function() {
        if (!window._sheetSyncUrl) return;
        var raw = localStorage.getItem('miguelini_data') || '[]';
        fetch(window._sheetSyncUrl, { method: 'POST', body: raw, headers: { 'Content-Type': 'application/json' } }).catch(function() {});
      };
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.background_color || defaultConfig.background_color,
                set: (value) => {
                  config.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => config.card_background || defaultConfig.card_background,
                set: (value) => {
                  config.card_background = value;
                  window.elementSdk.setConfig({ card_background: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.accent_color || defaultConfig.accent_color,
                set: (value) => {
                  config.accent_color = value;
                  window.elementSdk.setConfig({ accent_color: value });
                }
              },
              {
                get: () => config.button_color || defaultConfig.button_color,
                set: (value) => {
                  config.button_color = value;
                  window.elementSdk.setConfig({ button_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ['user_name', config.user_name || defaultConfig.user_name],
            ['dashboard_subtitle', config.dashboard_subtitle || defaultConfig.dashboard_subtitle],
            ['income_button_label', config.income_button_label || defaultConfig.income_button_label],
            ['expense_button_label', config.expense_button_label || defaultConfig.expense_button_label],
            ['debt_button_label', config.debt_button_label || defaultConfig.debt_button_label]
          ])
        });
      }
      
      await fetchBcvRate();
      
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        showToast('Error al inicializar la aplicación', 'error');
        return;
      }
      
      await checkAndProcessScheduledTransactions();
    }

    init();
  </script>
 </body>
</html>
